# -*- coding: utf-8 -*-
"""test_sp500.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1aiJ_XsYFF57ZyQsjPyIQPH5upC_lq---
"""

#ê°„ë‹¨ë²„ì „
import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta
import requests
import time

# í…”ë ˆê·¸ë¨ ë´‡ ì„¤ì • (ì‚¬ìš©ì ê°’ìœ¼ë¡œ ëŒ€ì²´)
TELEGRAM_TOKEN = '7734786706:AAEhu2w_KUtahzp14bBRlyu8WEUvZn6sa7M'
TELEGRAM_CHAT_ID = '309362453'

def send_telegram_message(message):
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
        payload = {'chat_id': TELEGRAM_CHAT_ID, 'text': message}
        response = requests.post(url, json=payload)
        response.raise_for_status()
        print("í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ")
    except Exception as e:
        print(f"í…”ë ˆê·¸ë¨ ì „ì†¡ ì˜¤ë¥˜: {e}")

# S&P 500 í‹°ì»¤ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (ê°„ì†Œí™”: ì¼ë¶€ í‹°ì»¤ë§Œ ì‚¬ìš©)
def get_sp500_tickers():
    return [
        'AAPL', 'MSFT', 'AMZN', 'GOOGL', 'META', 'TSLA', 'NVDA', 'JPM', 'HD', 'PFE'
    ]

# AAPL ê¸°ì¤€ ìµœì‹  ê±°ë˜ì¼
def get_latest_trading_day():
    try:
        data = yf.download('AAPL', start=(datetime.now() - timedelta(days=10)).strftime('%Y-%m-%d'), end=datetime.now().strftime('%Y-%m-%d'), progress=False)
        if data.empty:
            raise ValueError("AAPL ë°ì´í„° ì—†ìŒ")
        return data.index[-1].strftime('%Y-%m-%d')
    except Exception as e:
        print(f"AAPL ìµœì‹  ê±°ë˜ì¼ ì˜¤ë¥˜: {e}")
        return (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')

# í‹°ì»¤ ë¦¬ìŠ¤íŠ¸
sp500 = get_sp500_tickers()
total_tickers = len(sp500)

# ë‚ ì§œ ì„¤ì •
end_date = get_latest_trading_day()  # 2025-10-07
start_date = (datetime.strptime(end_date, '%Y-%m-%d') - timedelta(days=100)).strftime('%Y-%m-%d')

# ê²°ê³¼ ë¦¬ìŠ¤íŠ¸
ì •ë°°ì—´ = []
ì—­ë°°ì—´ = []
ì‹ ê·œ_ì •ë°°ì—´ = []  # (í‹°ì»¤, ë³€í™”ìœ¨)
ì •ë°°ì—´_ì´íƒˆ = []  # (í‹°ì»¤, ë³€í™”ìœ¨)

for symbol in sp500:
    try:
        data = yf.download(symbol, start=start_date, end=end_date, progress=False, auto_adjust=True)
        if data.empty or 'Close' not in data.columns:
            print(f"{symbol} ë°ì´í„° ì—†ìŒ ë˜ëŠ” 'Close' ì—´ ëˆ„ë½")
            continue
        data = data[['Close']].copy().sort_index(ascending=True).dropna()

        if len(data) < 50:
            print(f"{symbol} ë°ì´í„° ë¶€ì¡± ({len(data)} rows)")
            continue

        # EMA ê³„ì‚°
        data['10ema'] = data['Close'].ewm(span=10, adjust=False).mean()
        data['20ema'] = data['Close'].ewm(span=20, adjust=False).mean()
        data['50ema'] = data['Close'].ewm(span=50, adjust=False).mean()

        # ì •ë°°ì—´ ë° ì—­ë°°ì—´
        data['ì •ë°°ì—´'] = (data['10ema'] > data['20ema']) & (data['20ema'] > data['50ema'])
        data['ì—­ë°°ì—´'] = (data['10ema'] < data['20ema']) & (data['20ema'] < data['50ema'])

        # ìµœì‹  í–‰ (Tì¼)
        if data['ì •ë°°ì—´'].iloc[-1]:
            ì •ë°°ì—´.append(symbol)
        if data['ì—­ë°°ì—´'].iloc[-1]:
            ì—­ë°°ì—´.append(symbol)

        # ì‹ ê·œ ì •ë°°ì—´ ë° ì •ë°°ì—´ ì´íƒˆ
        if len(data) >= 6:
            prev_bullish = data['ì •ë°°ì—´'].shift(5).fillna(False).iloc[-1]
            curr_bullish = data['ì •ë°°ì—´'].iloc[-1]
            try:
                close_t = float(data['Close'].iloc[-1])
                close_t_minus_1 = float(data['Close'].iloc[-2]) if len(data) >= 2 else close_t
                close_t_minus_5 = float(data['Close'].iloc[-6])
                ema10_t = float(data['10ema'].iloc[-1])
                ema10_t_minus_1 = float(data['10ema'].iloc[-2]) if len(data) >= 2 else ema10_t
                price_change = ((close_t - close_t_minus_5) / close_t_minus_5) * 100
            except Exception as e:
                print(f"{symbol} ë³€í™”ìœ¨ ê³„ì‚° ì˜¤ë¥˜: {e}")
                price_change = 0.0

            if not prev_bullish and curr_bullish:
                ì‹ ê·œ_ì •ë°°ì—´.append((symbol, price_change))
            if prev_bullish and not curr_bullish and close_t < ema10_t and close_t_minus_1 < ema10_t_minus_1:
                ì •ë°°ì—´_ì´íƒˆ.append((symbol, price_change))

        time.sleep(0.5)

    except Exception as e:
        print(f"{symbol} ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
        continue

# ë³€í™”ìœ¨ ê¸°ì¤€ ì •ë ¬
ì‹ ê·œ_ì •ë°°ì—´ = sorted(ì‹ ê·œ_ì •ë°°ì—´, key=lambda x: x[1], reverse=True)
ì •ë°°ì—´_ì´íƒˆ = sorted(ì •ë°°ì—´_ì´íƒˆ, key=lambda x: x[1])

# ë¹„ìœ¨ ê³„ì‚°
ì •ë°°ì—´_ë¹„ìœ¨ = len(ì •ë°°ì—´) / total_tickers * 100 if total_tickers > 0 else 0
ì •ë°°ì—´_ì—­ë°°ì—´_ë¹„ìœ¨ = len(ì •ë°°ì—´) / len(ì—­ë°°ì—´) if len(ì—­ë°°ì—´) > 0 else float('inf')
ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨ = len(ì‹ ê·œ_ì •ë°°ì—´) / len(ì •ë°°ì—´_ì´íƒˆ) if len(ì •ë°°ì—´_ì´íƒˆ) > 0 else float('inf')

# ì¶œë ¥ ë©”ì‹œì§€ êµ¬ì„±
message = f"ğŸ“Š S&P 500 EMA(10,20,50) ê°„ë‹¨ ìš”ì•½ ({end_date}):\n"
message += f"ì „ì²´ ì¢…ëª© ({total_tickers}ê°œ):\n"
message += f"- ì •ë°°ì—´: {len(ì •ë°°ì—´)}ê°œ ({ì •ë°°ì—´_ë¹„ìœ¨:.2f}%)\n"
message += f"- ì—­ë°°ì—´: {len(ì—­ë°°ì—´)}ê°œ\n"
message += f"- ì‹ ê·œ ì •ë°°ì—´: {len(ì‹ ê·œ_ì •ë°°ì—´)}ê°œ\n"
message += f"- ì •ë°°ì—´ ì´íƒˆ: {len(ì •ë°°ì—´_ì´íƒˆ)}ê°œ\n"
message += f"- ì •ë°°ì—´/ì—­ë°°ì—´ ë¹„ìœ¨: {ì •ë°°ì—´_ì—­ë°°ì—´_ë¹„ìœ¨:.2f}\n"
message += f"- ì‹ ê·œ ì •ë°°ì—´/ì´íƒˆ ë¹„ìœ¨: {ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨:.2f}\n"
message += f"\nğŸ“Š ìƒì„¸ ê²°ê³¼:\n"
message += f"ì •ë°°ì—´ ì¢…ëª©: {', '.join(ì •ë°°ì—´) if ì •ë°°ì—´ else 'ì—†ìŒ'}\n"
message += f"ì—­ë°°ì—´ ì¢…ëª©: {', '.join(ì—­ë°°ì—´) if ì—­ë°°ì—´ else 'ì—†ìŒ'}\n"
message += f"ì‹ ê·œ ì •ë°°ì—´ ì¢…ëª© (5ì¼ ì „ ëŒ€ë¹„ Close ë³€í™”ìœ¨ ë†’ì€ ìˆœ):\n"
for symbol, change in ì‹ ê·œ_ì •ë°°ì—´:
    message += f"  - {symbol}: {change:.2f}%\n"
message += f"ì •ë°°ì—´ ì´íƒˆ ì¢…ëª© (5ì¼ ì „ ëŒ€ë¹„ Close ë³€í™”ìœ¨ ë‚®ì€ ìˆœ):\n"
for symbol, change in ì •ë°°ì—´_ì´íƒˆ:
    message += f"  - {symbol}: {change:.2f}%\n"

# í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡
send_telegram_message(message)

# ì½˜ì†” ì¶œë ¥
print(message)