# -*- coding: utf-8 -*-
"""spx_alignment.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/17GH8laeOjz3BEDKIog0SH2aA7S34BYfW
"""

import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta
import requests
import io
import time

# í…”ë ˆê·¸ë¨ ë´‡ ì„¤ì •
TELEGRAM_TOKEN = '7734786706:AAEhu2w_KUtahzp14bBRlyu8WEUvZn6sa7M'
TELEGRAM_CHAT_ID = '309362453'

def send_telegram_message(message):
    try:
        # ë©”ì‹œì§€ ê¸¸ì´ ì œí•œ (4096ì ì´ˆê³¼ ì‹œ ë¶„í• )
        MAX_LENGTH = 4096
        if len(message) > MAX_LENGTH:
            for i in range(0, len(message), MAX_LENGTH):
                chunk = message[i:i + MAX_LENGTH]
                payload = {'chat_id': TELEGRAM_CHAT_ID, 'text': chunk}
                response = requests.post(f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage", json=payload)
                response.raise_for_status()
                time.sleep(1)  # API ì œí•œ ë°©ì§€
        else:
            payload = {'chat_id': TELEGRAM_CHAT_ID, 'text': message}
            response = requests.post(f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage", json=payload)
            response.raise_for_status()
        print("í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ")
    except Exception as e:
        print(f"í…”ë ˆê·¸ë¨ ì „ì†¡ ì˜¤ë¥˜: {e}")

# S&P 500 í‹°ì»¤ ë° ì„¹í„° ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
def get_sp500_tickers():
    try:
        url = 'https://raw.githubusercontent.com/datasets/s-and-p-500-companies/main/data/constituents.csv'
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'}
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        df_tickers = pd.read_csv(io.StringIO(response.text))
        df_tickers['Symbol'] = df_tickers['Symbol'].str.replace('.', '-', regex=False)
        print(f"S&P 500 í‹°ì»¤ {len(df_tickers)}ê°œ ë¡œë“œ ì™„ë£Œ.")
        return df_tickers[['Symbol', 'GICS Sector']].to_dict('records')
    except Exception as e:
        print(f"í‹°ì»¤ ë¡œë“œ ì˜¤ë¥˜: {e}")
        return [
            {'Symbol': 'AAPL', 'GICS Sector': 'Information Technology'},
            {'Symbol': 'MSFT', 'GICS Sector': 'Information Technology'},
            {'Symbol': 'AMZN', 'GICS Sector': 'Consumer Discretionary'},
            {'Symbol': 'GOOGL', 'GICS Sector': 'Communication Services'},
            {'Symbol': 'META', 'GICS Sector': 'Communication Services'},
            {'Symbol': 'TSLA', 'GICS Sector': 'Consumer Discretionary'},
            {'Symbol': 'NVDA', 'GICS Sector': 'Information Technology'},
            {'Symbol': 'JPM', 'GICS Sector': 'Financials'},
            {'Symbol': 'HD', 'GICS Sector': 'Consumer Discretionary'},
            {'Symbol': 'PFE', 'GICS Sector': 'Health Care'},
            {'Symbol': 'CVX', 'GICS Sector': 'Energy'},
            {'Symbol': 'XOM', 'GICS Sector': 'Energy'}
        ]

# ì‹œì´ ìƒìœ„ 100ì¢…ëª© ì¶”ì¶œ
def get_top_100_by_market_cap(tickers):
    market_caps = []
    for item in tickers:
        symbol = item['Symbol']
        try:
            ticker = yf.Ticker(symbol)
            market_cap = ticker.info.get('marketCap', 0) / 1e8  # ì–µ ë‹¬ëŸ¬
            market_caps.append((symbol, market_cap, item['GICS Sector']))
            time.sleep(0.1)
        except Exception as e:
            print(f"{symbol} ì‹œì´ ë°ì´í„° ì˜¤ë¥˜: {e}")
    market_caps = sorted(market_caps, key=lambda x: x[1], reverse=True)[:100]
    return market_caps

# AAPL ê¸°ì¤€ ìµœì‹  ê±°ë˜ì¼
def get_latest_trading_day():
    try:
        data = yf.download('AAPL', start=(datetime.now() - timedelta(days=10)).strftime('%Y-%m-%d'), end=datetime.now().strftime('%Y-%m-%d'), progress=False)
        if data.empty:
            raise ValueError("AAPL ë°ì´í„° ì—†ìŒ")
        return data.index[-1].strftime('%Y-%m-%d')
    except Exception as e:
        print(f"AAPL ìµœì‹  ê±°ë˜ì¼ ì˜¤ë¥˜: {e}")
        return (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')

# í‹°ì»¤ ë° ì„¹í„° ë¦¬ìŠ¤íŠ¸
sp500 = get_sp500_tickers()
total_tickers = len(sp500)

# ë‚ ì§œ ì„¤ì •
end_date = get_latest_trading_day()  # 2025-10-07
start_date = (datetime.strptime(end_date, '%Y-%m-%d') - timedelta(days=100)).strftime('%Y-%m-%d')

# ê²°ê³¼ ë¦¬ìŠ¤íŠ¸
ì •ë°°ì—´ = []
ì—­ë°°ì—´ = []
ì‹ ê·œ_ì •ë°°ì—´ = []  # (í‹°ì»¤, ë³€í™”ìœ¨)
ì •ë°°ì—´_ì´íƒˆ = []  # (í‹°ì»¤, ë³€í™”ìœ¨)
top_100_ì •ë°°ì—´ = []
top_100_ì—­ë°°ì—´ = []
top_100_ì‹ ê·œ_ì •ë°°ì—´ = []
top_100_ì •ë°°ì—´_ì´íƒˆ = []
sector_data = {sector: {'ì •ë°°ì—´': [], 'ì—­ë°°ì—´': [], 'ì‹ ê·œ_ì •ë°°ì—´': [], 'ì •ë°°ì—´_ì´íƒˆ': [], 'total': 0} for sector in set(item['GICS Sector'] for item in sp500)}

# ì„¹í„°ë³„ ì¢…ëª© ìˆ˜ ê³„ì‚°
for item in sp500:
    sector_data[item['GICS Sector']]['total'] += 1

# ì‹œì´ ìƒìœ„ 100ì¢…ëª©
top_100 = get_top_100_by_market_cap(sp500)
top_100_tickers = [x[0] for x in top_100]

for item in sp500:
    symbol = item['Symbol']
    sector = item['GICS Sector']
    try:
        data = yf.download(symbol, start=start_date, end=end_date, progress=False, auto_adjust=True)
        if data.empty or 'Close' not in data.columns:
            print(f"{symbol} ë°ì´í„° ì—†ìŒ ë˜ëŠ” 'Close' ì—´ ëˆ„ë½")
            continue
        data = data[['Close']].copy().sort_index(ascending=True).dropna()

        if len(data) < 50:
            print(f"{symbol} ë°ì´í„° ë¶€ì¡± ({len(data)} rows)")
            continue

        # EMA ê³„ì‚°
        data['10ema'] = data['Close'].ewm(span=10, adjust=False).mean()
        data['20ema'] = data['Close'].ewm(span=20, adjust=False).mean()
        data['50ema'] = data['Close'].ewm(span=50, adjust=False).mean()

        # ì •ë°°ì—´ ë° ì—­ë°°ì—´
        data['ì •ë°°ì—´'] = (data['10ema'] > data['20ema']) & (data['20ema'] > data['50ema'])
        data['ì—­ë°°ì—´'] = (data['10ema'] < data['20ema']) & (data['20ema'] < data['50ema'])

        # ìµœì‹  í–‰ (Tì¼)
        if data['ì •ë°°ì—´'].iloc[-1]:
            ì •ë°°ì—´.append(symbol)
            if symbol in top_100_tickers:
                top_100_ì •ë°°ì—´.append(symbol)
            sector_data[sector]['ì •ë°°ì—´'].append(symbol)
        if data['ì—­ë°°ì—´'].iloc[-1]:
            ì—­ë°°ì—´.append(symbol)
            if symbol in top_100_tickers:
                top_100_ì—­ë°°ì—´.append(symbol)
            sector_data[sector]['ì—­ë°°ì—´'].append(symbol)

        # ì‹ ê·œ ì •ë°°ì—´ ë° ì •ë°°ì—´ ì´íƒˆ
        if len(data) >= 6:
            prev_bullish = data['ì •ë°°ì—´'].shift(5).fillna(False).iloc[-1]
            curr_bullish = data['ì •ë°°ì—´'].iloc[-1]
            try:
                close_t = float(data['Close'].iloc[-1])
                close_t_minus_1 = float(data['Close'].iloc[-2]) if len(data) >= 2 else close_t
                close_t_minus_5 = float(data['Close'].iloc[-6])
                ema10_t = float(data['10ema'].iloc[-1])
                ema10_t_minus_1 = float(data['10ema'].iloc[-2]) if len(data) >= 2 else ema10_t
                price_change = ((close_t - close_t_minus_5) / close_t_minus_5) * 100
            except Exception as e:
                print(f"{symbol} ë³€í™”ìœ¨ ê³„ì‚° ì˜¤ë¥˜: {e}")
                price_change = 0.0

            if not prev_bullish and curr_bullish:
                ì‹ ê·œ_ì •ë°°ì—´.append((symbol, price_change))
                if symbol in top_100_tickers:
                    top_100_ì‹ ê·œ_ì •ë°°ì—´.append((symbol, price_change))
                sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´'].append((symbol, price_change))
            if prev_bullish and not curr_bullish and close_t < ema10_t and close_t_minus_1 < ema10_t_minus_1:
                ì •ë°°ì—´_ì´íƒˆ.append((symbol, price_change))
                if symbol in top_100_tickers:
                    top_100_ì •ë°°ì—´_ì´íƒˆ.append((symbol, price_change))
                sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ'].append((symbol, price_change))

        time.sleep(0.5)

    except Exception as e:
        print(f"{symbol} ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
        continue

# ë³€í™”ìœ¨ ê¸°ì¤€ ì •ë ¬
ì‹ ê·œ_ì •ë°°ì—´ = sorted(ì‹ ê·œ_ì •ë°°ì—´, key=lambda x: x[1], reverse=True)
ì •ë°°ì—´_ì´íƒˆ = sorted(ì •ë°°ì—´_ì´íƒˆ, key=lambda x: x[1])
top_100_ì‹ ê·œ_ì •ë°°ì—´ = sorted(top_100_ì‹ ê·œ_ì •ë°°ì—´, key=lambda x: x[1], reverse=True)
top_100_ì •ë°°ì—´_ì´íƒˆ = sorted(top_100_ì •ë°°ì—´_ì´íƒˆ, key=lambda x: x[1])
for sector in sector_data:
    sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´'] = sorted(sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´'], key=lambda x: x[1], reverse=True)
    sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ'] = sorted(sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ'], key=lambda x: x[1])

# ë¹„ìœ¨ ê³„ì‚°
ì •ë°°ì—´_ë¹„ìœ¨ = len(ì •ë°°ì—´) / total_tickers * 100 if total_tickers > 0 else 0
ì •ë°°ì—´_ì—­ë°°ì—´_ë¹„ìœ¨ = len(ì •ë°°ì—´) / len(ì—­ë°°ì—´) if len(ì—­ë°°ì—´) > 0 else float('inf')
ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨ = len(ì‹ ê·œ_ì •ë°°ì—´) / len(ì •ë°°ì—´_ì´íƒˆ) if len(ì •ë°°ì—´_ì´íƒˆ) > 0 else float('inf')
top_100_ì •ë°°ì—´_ë¹„ìœ¨ = len(top_100_ì •ë°°ì—´) / len(top_100_tickers) * 100 if top_100_tickers else 0
top_100_ì •ë°°ì—´_ì—­ë°°ì—´_ë¹„ìœ¨ = len(top_100_ì •ë°°ì—´) / len(top_100_ì—­ë°°ì—´) if len(top_100_ì—­ë°°ì—´) > 0 else float('inf')
top_100_ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨ = len(top_100_ì‹ ê·œ_ì •ë°°ì—´) / len(top_100_ì •ë°°ì—´_ì´íƒˆ) if len(top_100_ì •ë°°ì—´_ì´íƒˆ) > 0 else float('inf')
sector_stats = {}
for sector in sector_data:
    total = sector_data[sector]['total']
    sector_stats[sector] = {
        'ì •ë°°ì—´_ë¹„ìœ¨': len(sector_data[sector]['ì •ë°°ì—´']) / total * 100 if total > 0 else 0,
        'ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨': len(sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´']) / len(sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ']) if len(sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ']) > 0 else float('inf')
    }

# ì¶œë ¥ ë©”ì‹œì§€ êµ¬ì„±
message = f"ğŸ“Š S&P 500 EMA(10,20,50) ìš”ì•½ ({end_date}):\n"
message += f"ì „ì²´ ì¢…ëª© ({total_tickers}ê°œ):\n"
message += f"- ì •ë°°ì—´: {len(ì •ë°°ì—´)}ê°œ ({ì •ë°°ì—´_ë¹„ìœ¨:.2f}%)\n"
message += f"- ì—­ë°°ì—´: {len(ì—­ë°°ì—´)}ê°œ\n"
message += f"- ì‹ ê·œ ì •ë°°ì—´: {len(ì‹ ê·œ_ì •ë°°ì—´)}ê°œ\n"
message += f"- ì •ë°°ì—´ ì´íƒˆ: {len(ì •ë°°ì—´_ì´íƒˆ)}ê°œ\n"
message += f"- ì •ë°°ì—´/ì—­ë°°ì—´ ë¹„ìœ¨: {ì •ë°°ì—´_ì—­ë°°ì—´_ë¹„ìœ¨:.2f}\n"
message += f"- ì‹ ê·œ ì •ë°°ì—´/ì´íƒˆ ë¹„ìœ¨: {ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨:.2f}\n"
message += f"\nì‹œì´ ìƒìœ„ 100ì¢…ëª©:\n"
message += f"- ì •ë°°ì—´: {len(top_100_ì •ë°°ì—´)}ê°œ ({top_100_ì •ë°°ì—´_ë¹„ìœ¨:.2f}%)\n"
message += f"- ì‹ ê·œ ì •ë°°ì—´/ì´íƒˆ ë¹„ìœ¨: {top_100_ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨:.2f}\n"
message += f"\nì„¹í„°ë³„ ì •ë°°ì—´ ë¹„ìœ¨:\n"
for sector in sorted(sector_stats.keys()):
    message += f"- {sector}: {sector_stats[sector]['ì •ë°°ì—´_ë¹„ìœ¨']:.2f}% (ì‹ ê·œ/ì´íƒˆ ë¹„ìœ¨: {sector_stats[sector]['ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨']:.2f})\n"
message += f"\nğŸ“Š ì „ì²´ ìƒì„¸ ê²°ê³¼:\n"
message += f"ì •ë°°ì—´ ì¢…ëª© ({len(ì •ë°°ì—´)}ê°œ, ë¹„ìœ¨: {ì •ë°°ì—´_ë¹„ìœ¨:.2f}%): {', '.join(ì •ë°°ì—´) if ì •ë°°ì—´ else 'ì—†ìŒ'}\n"
message += f"ì—­ë°°ì—´ ì¢…ëª© ({len(ì—­ë°°ì—´)}ê°œ): {', '.join(ì—­ë°°ì—´) if ì—­ë°°ì—´ else 'ì—†ìŒ'}\n"
message += f"ì‹ ê·œ ì •ë°°ì—´ ì¢…ëª© ({len(ì‹ ê·œ_ì •ë°°ì—´)}ê°œ, 5ì¼ ì „ ëŒ€ë¹„ Close ë³€í™”ìœ¨ ë†’ì€ ìˆœ):\n"
for symbol, change in ì‹ ê·œ_ì •ë°°ì—´:
    message += f"  - {symbol}: {change:.2f}%\n"
message += f"ì •ë°°ì—´ ì´íƒˆ ì¢…ëª© ({len(ì •ë°°ì—´_ì´íƒˆ)}ê°œ, 5ì¼ ì „ ëŒ€ë¹„ Close ë³€í™”ìœ¨ ë‚®ì€ ìˆœ):\n"
for symbol, change in ì •ë°°ì—´_ì´íƒˆ:
    message += f"  - {symbol}: {change:.2f}%\n"
message += f"\nğŸ“ˆ ë¹„ìœ¨ í†µê³„:\n"
message += f"- ì •ë°°ì—´ ë¹„ìœ¨: {ì •ë°°ì—´_ë¹„ìœ¨:.2f}% (ì •ë°°ì—´ {len(ì •ë°°ì—´)} / ì „ì²´ {total_tickers})\n"
message += f"- ì •ë°°ì—´/ì—­ë°°ì—´ ë¹„ìœ¨: {ì •ë°°ì—´_ì—­ë°°ì—´_ë¹„ìœ¨:.2f} (ì •ë°°ì—´ {len(ì •ë°°ì—´)} / ì—­ë°°ì—´ {len(ì—­ë°°ì—´)})\n"
message += f"- ì‹ ê·œ ì •ë°°ì—´/ì •ë°°ì—´ ì´íƒˆ ë¹„ìœ¨: {ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨:.2f} (ì‹ ê·œ ì •ë°°ì—´ {len(ì‹ ê·œ_ì •ë°°ì—´)} / ì´íƒˆ {len(ì •ë°°ì—´_ì´íƒˆ)})\n"
message += f"\nğŸ“Š ì‹œì´ ìƒìœ„ 100ì¢…ëª© EMA(10,20,50) Update:\n"
message += f"ì •ë°°ì—´ ì¢…ëª© ({len(top_100_ì •ë°°ì—´)}ê°œ, ë¹„ìœ¨: {top_100_ì •ë°°ì—´_ë¹„ìœ¨:.2f}%): {', '.join(top_100_ì •ë°°ì—´) if top_100_ì •ë°°ì—´ else 'ì—†ìŒ'}\n"
message += f"ì—­ë°°ì—´ ì¢…ëª© ({len(top_100_ì—­ë°°ì—´)}ê°œ): {', '.join(top_100_ì—­ë°°ì—´) if top_100_ì—­ë°°ì—´ else 'ì—†ìŒ'}\n"
message += f"ì‹ ê·œ ì •ë°°ì—´ ì¢…ëª© ({len(top_100_ì‹ ê·œ_ì •ë°°ì—´)}ê°œ, 5ì¼ ì „ ëŒ€ë¹„ Close ë³€í™”ìœ¨ ë†’ì€ ìˆœ):\n"
for symbol, change in top_100_ì‹ ê·œ_ì •ë°°ì—´:
    message += f"  - {symbol}: {change:.2f}%\n"
message += f"ì •ë°°ì—´ ì´íƒˆ ì¢…ëª© ({len(top_100_ì •ë°°ì—´_ì´íƒˆ)}ê°œ, 5ì¼ ì „ ëŒ€ë¹„ Close ë³€í™”ìœ¨ ë‚®ì€ ìˆœ):\n"
for symbol, change in top_100_ì •ë°°ì—´_ì´íƒˆ:
    message += f"  - {symbol}: {change:.2f}%\n"
message += f"\nğŸ“ˆ ì‹œì´ ìƒìœ„ 100ì¢…ëª© ë¹„ìœ¨ í†µê³„:\n"
message += f"- ì •ë°°ì—´ ë¹„ìœ¨: {top_100_ì •ë°°ì—´_ë¹„ìœ¨:.2f}% (ì •ë°°ì—´ {len(top_100_ì •ë°°ì—´)} / ìƒìœ„ 100)\n"
message += f"- ì •ë°°ì—´/ì—­ë°°ì—´ ë¹„ìœ¨: {top_100_ì •ë°°ì—´_ì—­ë°°ì—´_ë¹„ìœ¨:.2f} (ì •ë°°ì—´ {len(top_100_ì •ë°°ì—´)} / ì—­ë°°ì—´ {len(top_100_ì—­ë°°ì—´)})\n"
message += f"- ì‹ ê·œ ì •ë°°ì—´/ì •ë°°ì—´ ì´íƒˆ ë¹„ìœ¨: {top_100_ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨:.2f} (ì‹ ê·œ ì •ë°°ì—´ {len(top_100_ì‹ ê·œ_ì •ë°°ì—´)} / ì´íƒˆ {len(top_100_ì •ë°°ì—´_ì´íƒˆ)})\n"
message += f"\nğŸ“Š ì„¹í„°ë³„ EMA(10,20,50) Update:\n"
for sector in sorted(sector_data.keys()):
    message += f"\n{sector}:\n"
    message += f"  - ì •ë°°ì—´ ({len(sector_data[sector]['ì •ë°°ì—´'])}ê°œ): {', '.join(sector_data[sector]['ì •ë°°ì—´']) if sector_data[sector]['ì •ë°°ì—´'] else 'ì—†ìŒ'}\n"
    message += f"  - ì—­ë°°ì—´ ({len(sector_data[sector]['ì—­ë°°ì—´'])}ê°œ): {', '.join(sector_data[sector]['ì—­ë°°ì—´']) if sector_data[sector]['ì—­ë°°ì—´'] else 'ì—†ìŒ'}\n"
    message += f"  - ì‹ ê·œ ì •ë°°ì—´ ({len(sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´'])}ê°œ, ë³€í™”ìœ¨ ë†’ì€ ìˆœ):\n"
    for symbol, change in sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´']:
        message += f"    - {symbol}: {change:.2f}%\n"
    message += f"  - ì •ë°°ì—´ ì´íƒˆ ({len(sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ'])}ê°œ, ë³€í™”ìœ¨ ë‚®ì€ ìˆœ):\n"
    for symbol, change in sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ']:
        message += f"    - {symbol}: {change:.2f}%\n"

# í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡
send_telegram_message(message)

# ì½˜ì†” ì¶œë ¥
print(message)