# -*- coding: utf-8 -*-
"""spx_alignment.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/17GH8laeOjz3BEDKIog0SH2aA7S34BYfW
"""

import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta
import requests
import io
import time

# í…”ë ˆê·¸ë¨ ë´‡ ì„¤ì •
TELEGRAM_TOKEN = '7734786706:AAEhu2w_KUtahzp14bBRlyu8WEUvZn6sa7M'
TELEGRAM_CHAT_ID = '309362453'

def send_telegram_message(message):
    try:
        MAX_LENGTH = 4096
        if len(message) > MAX_LENGTH:
            for i in range(0, len(message), MAX_LENGTH):
                chunk = message[i:i + MAX_LENGTH]
                payload = {'chat_id': TELEGRAM_CHAT_ID, 'text': chunk}
                response = requests.post(f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage", json=payload)
                response.raise_for_status()
                time.sleep(1)
        else:
            payload = {'chat_id': TELEGRAM_CHAT_ID, 'text': message}
            response = requests.post(f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage", json=payload)
            response.raise_for_status()
        print("í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ")
    except Exception as e:
        print(f"í…”ë ˆê·¸ë¨ ì „ì†¡ ì˜¤ë¥˜: {e}")

# S&P 500 í‹°ì»¤ ë° ì„¹í„° ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
def get_sp500_tickers():
    try:
        url = 'https://raw.githubusercontent.com/datasets/s-and-p-500-companies/main/data/constituents.csv'
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'}
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        df_tickers = pd.read_csv(io.StringIO(response.text))
        df_tickers['Symbol'] = df_tickers['Symbol'].str.replace('.', '-', regex=False)
        print(f"S&P 500 í‹°ì»¤ {len(df_tickers)}ê°œ ë¡œë“œ ì™„ë£Œ.")
        return df_tickers[['Symbol', 'GICS Sector']].to_dict('records')
    except Exception as e:
        print(f"í‹°ì»¤ ë¡œë“œ ì˜¤ë¥˜: {e}")
        return [
            {'Symbol': 'AAPL', 'GICS Sector': 'Information Technology'},
            {'Symbol': 'MSFT', 'GICS Sector': 'Information Technology'},
            {'Symbol': 'AMZN', 'GICS Sector': 'Consumer Discretionary'},
            {'Symbol': 'GOOGL', 'GICS Sector': 'Communication Services'},
            {'Symbol': 'META', 'GICS Sector': 'Communication Services'},
            {'Symbol': 'TSLA', 'GICS Sector': 'Consumer Discretionary'},
            {'Symbol': 'NVDA', 'GICS Sector': 'Information Technology'},
            {'Symbol': 'JPM', 'GICS Sector': 'Financials'},
            {'Symbol': 'HD', 'GICS Sector': 'Consumer Discretionary'},
            {'Symbol': 'PFE', 'GICS Sector': 'Health Care'},
            {'Symbol': 'CVX', 'GICS Sector': 'Energy'},
            {'Symbol': 'XOM', 'GICS Sector': 'Energy'}
        ]

# ì‹œì´ ìƒìœ„ 100ì¢…ëª© ì¶”ì¶œ
def get_top_100_by_market_cap(tickers):
    market_caps = []
    for item in tickers:
        symbol = item['Symbol']
        try:
            ticker = yf.Ticker(symbol)
            market_cap = ticker.info.get('marketCap', 0) / 1e8
            market_caps.append((symbol, market_cap, item['GICS Sector']))
            time.sleep(0.1)
        except Exception as e:
            print(f"{symbol} ì‹œì´ ë°ì´í„° ì˜¤ë¥˜: {e}")
    market_caps = sorted(market_caps, key=lambda x: x[1], reverse=True)[:100]
    return market_caps

# AAPL ê¸°ì¤€ ìµœì‹  ê±°ë˜ì¼ (ê°•í™”ëœ ë²„ì „: ìµœê·¼ 7ì¼ ì¤‘ ë§ˆì§€ë§‰ ê±°ë˜ì¼ í™•ì‹¤íˆ ì°¾ê¸°)
def get_latest_trading_day():
    try:
        now_utc = datetime.utcnow()
        print(f"UTC í˜„ì¬ ì‹œê°„: {now_utc}")

        # ìµœê·¼ 7ì¼ê°„ ë°ì´í„° ë‹¤ìš´ë¡œë“œí•˜ì—¬ í™•ì‹¤í•œ ë§ˆì§€ë§‰ ê±°ë˜ì¼ ì°¾ê¸°
        start_str = (now_utc - timedelta(days=7)).strftime('%Y-%m-%d')
        end_str = (now_utc + timedelta(days=1)).strftime('%Y-%m-%d')  # endëŠ” ë‹¤ìŒë‚  í¬í•¨

        print(f"Download period: {start_str} to {end_str}")

        data = yf.download('AAPL', start=start_str, end=end_str, progress=False)
        if data.empty:
            print("yfinance ë°ì´í„° empty - fallback to yesterday")
            fallback_date = (now_utc - timedelta(days=1)).strftime('%Y-%m-%d')
            print(f"Fallback end_date: {fallback_date}")
            return fallback_date

        # ê°€ì¥ ìµœê·¼ ê±°ë˜ì¼ ì°¾ê¸° (ì£¼ë§/ê³µíœ´ì¼ ì œì™¸)
        last_date = data.index[-1]
        last_date_str = last_date.strftime('%Y-%m-%d')
        print(f"yfinance ë§ˆì§€ë§‰ ê±°ë˜ì¼: {last_date_str} ({last_date.weekday()})")

        # ì£¼ë§ì´ë©´ ì´ì „ ê±°ë˜ì¼ë¡œ ì¡°ì • (ì›”=0, ì¼=6)
        if last_date.weekday() >= 5:  # í† ìš”ì¼(5) ë˜ëŠ” ì¼ìš”ì¼(6)
            print("ë§ˆì§€ë§‰ ë‚ ì§œê°€ ì£¼ë§ì´ë¯€ë¡œ ì´ì „ ê±°ë˜ì¼ë¡œ ì¡°ì •")
            # ìµœê·¼ 14ì¼ ë°ì´í„°ì—ì„œ í‰ì¼ ë§ˆì§€ë§‰ ê±°ë˜ì¼ ì°¾ê¸°
            extended_start = (now_utc - timedelta(days=14)).strftime('%Y-%m-%d')
            extended_data = yf.download('AAPL', start=extended_start, end=end_str, progress=False)
            if not extended_data.empty:
                # í‰ì¼(ì›”-ê¸ˆ) ì¤‘ ê°€ì¥ ìµœê·¼ ë‚ ì§œ ì°¾ê¸°
                trading_days = extended_data[extended_data.index.weekday < 5]
                if not trading_days.empty:
                    last_date = trading_days.index[-1]
                    last_date_str = last_date.strftime('%Y-%m-%d')
                    print(f"ì¡°ì •ëœ ê±°ë˜ì¼: {last_date_str}")

        print(f"ìµœì¢… end_date: {last_date_str}")
        return last_date_str

    except Exception as e:
        print(f"AAPL ìµœì‹  ê±°ë˜ì¼ ì˜¤ë¥˜: {e} - fallback to yesterday")
        now_utc = datetime.utcnow()
        fallback_date = (now_utc - timedelta(days=1)).strftime('%Y-%m-%d')
        print(f"ìµœì¢… fallback end_date: {fallback_date}")
        return fallback_date

# í‹°ì»¤ ë° ì„¹í„° ë¦¬ìŠ¤íŠ¸
sp500 = get_sp500_tickers()
total_tickers = len(sp500)

# ë‚ ì§œ ì„¤ì •
end_date = get_latest_trading_day()
print(f"ë¶„ì„ ê¸°ì¤€ì¼ (end_date): {end_date}")
start_date = (datetime.strptime(end_date, '%Y-%m-%d') - timedelta(days=100)).strftime('%Y-%m-%d')
print(f"ë¶„ì„ ê¸°ê°„: {start_date} ~ {end_date}")

# ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
ì •ë°°ì—´ = []
ì—­ë°°ì—´ = []
ì‹ ê·œ_ì •ë°°ì—´ = []
ì •ë°°ì—´_ì´íƒˆ = []
top_100_ì •ë°°ì—´ = []
top_100_ì—­ë°°ì—´ = []
top_100_ì‹ ê·œ_ì •ë°°ì—´ = []
top_100_ì •ë°°ì—´_ì´íƒˆ = []
sector_data = {sector: {'ì •ë°°ì—´': [], 'ì—­ë°°ì—´': [], 'ì‹ ê·œ_ì •ë°°ì—´': [], 'ì •ë°°ì—´_ì´íƒˆ': [], 'total': 0}
               for sector in set(item['GICS Sector'] for item in sp500)}

# ì„¹í„°ë³„ ì¢…ëª© ìˆ˜ ê³„ì‚°
for item in sp500:
    sector_data[item['GICS Sector']]['total'] += 1

# ì‹œì´ ìƒìœ„ 100ì¢…ëª©
top_100 = get_top_100_by_market_cap(sp500)
top_100_tickers = [x[0] for x in top_100]

for item in sp500:
    symbol = item['Symbol']
    sector = item['GICS Sector']
    try:
        data = yf.download(symbol, start=start_date, end=end_date, progress=False, auto_adjust=True)
        if data.empty or 'Close' not in data.columns:
            print(f"{symbol} ë°ì´í„° ì—†ìŒ")
            continue
        data = data[['Close']].copy().sort_index(ascending=True).dropna()

        if len(data) < 50:
            continue

        # EMA ê³„ì‚°
        data['10ema'] = data['Close'].ewm(span=10, adjust=False).mean()
        data['20ema'] = data['Close'].ewm(span=20, adjust=False).mean()
        data['50ema'] = data['Close'].ewm(span=50, adjust=False).mean()

        # ì •ë°°ì—´ ë° ì—­ë°°ì—´
        data['ì •ë°°ì—´'] = (data['10ema'] > data['20ema']) & (data['20ema'] > data['50ema'])
        data['ì—­ë°°ì—´'] = (data['10ema'] < data['20ema']) & (data['20ema'] < data['50ema'])

        # Tì¼ ì •ë°°ì—´/ì—­ë°°ì—´ ì²´í¬
        if data['ì •ë°°ì—´'].iloc[-1]:
            ì •ë°°ì—´.append(symbol)
            if symbol in top_100_tickers:
                top_100_ì •ë°°ì—´.append(symbol)
            sector_data[sector]['ì •ë°°ì—´'].append(symbol)
        if data['ì—­ë°°ì—´'].iloc[-1]:
            ì—­ë°°ì—´.append(symbol)
            if symbol in top_100_tickers:
                top_100_ì—­ë°°ì—´.append(symbol)
            sector_data[sector]['ì—­ë°°ì—´'].append(symbol)

        # ì‹ ê·œ ì •ë°°ì—´ ë° ì •ë°°ì—´ ì´íƒˆ (T-1 vs T)
        if len(data) >= 2:
            prev_bullish = data['ì •ë°°ì—´'].shift(1).fillna(False).iloc[-1]  # T-1
            curr_bullish = data['ì •ë°°ì—´'].iloc[-1]  # T

            close_t = float(data['Close'].iloc[-1])  # Tì¼ ì¢…ê°€
            close_t_minus_1 = float(data['Close'].iloc[-2])  # T-1 ì¢…ê°€
            ema20_t = float(data['20ema'].iloc[-1])  # Tì¼ 20EMA (ìˆ˜ì •ë¨)
            price_change = ((close_t - close_t_minus_1) / close_t_minus_1) * 100

            # ì‹ ê·œ ì •ë°°ì—´: T-1 ì •ë°°ì—´ X â†’ T ì •ë°°ì—´ O
            if not prev_bullish and curr_bullish:
                ì‹ ê·œ_ì •ë°°ì—´.append((symbol, price_change))
                if symbol in top_100_tickers:
                    top_100_ì‹ ê·œ_ì •ë°°ì—´.append((symbol, price_change))
                sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´'].append((symbol, price_change))

            # ì •ë°°ì—´ ì´íƒˆ: T ì •ë°°ì—´ ìœ ì§€ + ì£¼ê°€ í•˜ë½ + 20EMA í„°ì¹˜/í•˜íšŒ (ìˆ˜ì •ë¨)
            if (curr_bullish and
                close_t < close_t_minus_1 and
                close_t <= ema20_t):  # 20EMA í„°ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½
                ì •ë°°ì—´_ì´íƒˆ.append((symbol, price_change))
                if symbol in top_100_tickers:
                    top_100_ì •ë°°ì—´_ì´íƒˆ.append((symbol, price_change))
                sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ'].append((symbol, price_change))

        time.sleep(0.5)

    except Exception as e:
        print(f"{symbol} ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
        continue

# ì •ë ¬
ì‹ ê·œ_ì •ë°°ì—´ = sorted(ì‹ ê·œ_ì •ë°°ì—´, key=lambda x: x[1], reverse=True)
ì •ë°°ì—´_ì´íƒˆ = sorted(ì •ë°°ì—´_ì´íƒˆ, key=lambda x: x[1])
top_100_ì‹ ê·œ_ì •ë°°ì—´ = sorted(top_100_ì‹ ê·œ_ì •ë°°ì—´, key=lambda x: x[1], reverse=True)
top_100_ì •ë°°ì—´_ì´íƒˆ = sorted(top_100_ì •ë°°ì—´_ì´íƒˆ, key=lambda x: x[1])

for sector in sector_data:
    sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´'] = sorted(sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´'], key=lambda x: x[1], reverse=True)
    sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ'] = sorted(sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ'], key=lambda x: x[1])

# ë¹„ìœ¨ ê³„ì‚°
ì •ë°°ì—´_ë¹„ìœ¨ = len(ì •ë°°ì—´) / total_tickers * 100 if total_tickers > 0 else 0
ì •ë°°ì—´_ì—­ë°°ì—´_ë¹„ìœ¨ = len(ì •ë°°ì—´) / len(ì—­ë°°ì—´) if len(ì—­ë°°ì—´) > 0 else float('inf')
ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨ = len(ì‹ ê·œ_ì •ë°°ì—´) / len(ì •ë°°ì—´_ì´íƒˆ) if len(ì •ë°°ì—´_ì´íƒˆ) > 0 else float('inf')
top_100_ì •ë°°ì—´_ë¹„ìœ¨ = len(top_100_ì •ë°°ì—´) / len(top_100_tickers) * 100 if top_100_tickers else 0
top_100_ì •ë°°ì—´_ì—­ë°°ì—´_ë¹„ìœ¨ = len(top_100_ì •ë°°ì—´) / len(top_100_ì—­ë°°ì—´) if len(top_100_ì—­ë°°ì—´) > 0 else float('inf')
top_100_ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨ = len(top_100_ì‹ ê·œ_ì •ë°°ì—´) / len(top_100_ì •ë°°ì—´_ì´íƒˆ) if len(top_100_ì •ë°°ì—´_ì´íƒˆ) > 0 else float('inf')

sector_stats = {}
for sector in sector_data:
    total = sector_data[sector]['total']
    sector_stats[sector] = {
        'ì •ë°°ì—´_ë¹„ìœ¨': len(sector_data[sector]['ì •ë°°ì—´']) / total * 100 if total > 0 else 0,
        'ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨': len(sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´']) / len(sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ']) if len(sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ']) > 0 else float('inf')
    }

# ì„¹í„° ìƒìœ„/í•˜ìœ„ 3ê°œ
sorted_sectors = sorted(sector_stats.items(), key=lambda x: x[1]['ì •ë°°ì—´_ë¹„ìœ¨'], reverse=True)
top_3_sectors = sorted_sectors[:3]
bottom_3_sectors = sorted_sectors[-3:] if len(sorted_sectors) >= 3 else sorted_sectors

# ë©”ì‹œì§€ êµ¬ì„±
message = f"ğŸ“Š S&P 500 EMA(10,20,50) ìš”ì•½ ({end_date}):\n"
message += f"- ì •ë°°ì—´: {len(ì •ë°°ì—´)}ê°œ ({ì •ë°°ì—´_ë¹„ìœ¨:.2f}%)\n"
message += f"- ì‹ ê·œ ì •ë°°ì—´: {len(ì‹ ê·œ_ì •ë°°ì—´)}ê°œ\n"
message += f"- ì •ë°°ì—´ ì´íƒˆ: {len(ì •ë°°ì—´_ì´íƒˆ)}ê°œ\n"
message += f"- ì‹ ê·œ ì •ë°°ì—´/ì´íƒˆ ë¹„ìœ¨: {ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨:.2f}\n"
message += f"\nì‹œì´ ìƒìœ„ 100ì¢…ëª©:\n"
message += f"- ì •ë°°ì—´: {len(top_100_ì •ë°°ì—´)}ê°œ ({top_100_ì •ë°°ì—´_ë¹„ìœ¨:.2f}%)\n"
message += f"- ì‹ ê·œ ì •ë°°ì—´/ì´íƒˆ ë¹„ìœ¨: {top_100_ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨:.2f}\n"

message += f"\nì„¹í„°ë³„ ì •ë°°ì—´ ë¹„ìœ¨ (ìƒìœ„ 3ê°œ ë° í•˜ìœ„ 3ê°œ):\nìƒìœ„ 3ê°œ:\n"
for sector, stats in top_3_sectors:
    message += f"- {sector}: {stats['ì •ë°°ì—´_ë¹„ìœ¨']:.2f}% (ì‹ ê·œ/ì´íƒˆ: {stats['ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨']:.2f})\n"
message += f"í•˜ìœ„ 3ê°œ:\n"
for sector, stats in bottom_3_sectors:
    message += f"- {sector}: {stats['ì •ë°°ì—´_ë¹„ìœ¨']:.2f}% (ì‹ ê·œ/ì´íƒˆ: {stats['ì‹ ê·œì •ë°°ì—´_ì´íƒˆ_ë¹„ìœ¨']:.2f})\n"

message += f"\nğŸ“Š ì „ì²´ ìƒì„¸ ê²°ê³¼ (T-1 ëŒ€ë¹„ ë³€í™”ìœ¨):\n"
message += f"ì‹ ê·œ ì •ë°°ì—´ ({len(ì‹ ê·œ_ì •ë°°ì—´)}ê°œ, ë†’ì€ ìˆœ):\n"
for symbol, change in ì‹ ê·œ_ì •ë°°ì—´[:10]:  # ìƒìœ„ 10ê°œë§Œ
    message += f"  - {symbol}: {change:.2f}%\n"
message += f"ì •ë°°ì—´ ì´íƒˆ ({len(ì •ë°°ì—´_ì´íƒˆ)}ê°œ, ë‚®ì€ ìˆœ):\n"
for symbol, change in ì •ë°°ì—´_ì´íƒˆ[:10]:  # í•˜ìœ„ 10ê°œë§Œ
    message += f"  - {symbol}: {change:.2f}%\n"

# ì‹œì´ ìƒìœ„ 100ì¢…ëª© ìƒì„¸
message += f"\nğŸ“Š ì‹œì´ ìƒìœ„ 100 ì‹ ê·œ ì •ë°°ì—´:\n"
for symbol, change in top_100_ì‹ ê·œ_ì •ë°°ì—´:
    message += f"  - {symbol}: {change:.2f}%\n"
message += f"ì‹œì´ ìƒìœ„ 100 ì •ë°°ì—´ ì´íƒˆ:\n"
for symbol, change in top_100_ì •ë°°ì—´_ì´íƒˆ:
    message += f"  - {symbol}: {change:.2f}%\n"

# ì„¹í„°ë³„ (ê°„ëµí™”)
message += f"\nğŸ“Š ì„¹í„°ë³„ ì‹ ê·œ/ì´íƒˆ (ì£¼ìš” ì„¹í„°):\n"
for sector in ['Information Technology', 'Financials', 'Health Care', 'Consumer Discretionary']:
    if sector in sector_data:
        message += f"{sector} (ì •ë°°ì—´ {sector_stats[sector]['ì •ë°°ì—´_ë¹„ìœ¨']:.1f}%):\n"
        new_bull = sector_data[sector]['ì‹ ê·œ_ì •ë°°ì—´']
        exits = sector_data[sector]['ì •ë°°ì—´_ì´íƒˆ']
        if new_bull:
            message += f"  ì‹ ê·œ: {new_bull[0][0]} {new_bull[0][1]:.2f}%\n"
        if exits:
            message += f"  ì´íƒˆ: {exits[0][0]} {exits[0][1]:.2f}%\n"

send_telegram_message(message)
print(message)